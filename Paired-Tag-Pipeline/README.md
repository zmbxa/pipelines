# Paired-Tag Pipeline

## How to use it (Lab server)  
**1).** Install miniconda  
```
bash /storage/zhangyanxiaoLab/xiongxiong/Software/Miniconda3-4.5.4-Linux-x86_64.sh
```

**2).** Add required software path to your .bashrc, then activate it.  
```
export PATH=$PATH:/storage/zhangyanxiaoLab/xiongxiong/Link/  
source ~/.bashrc  
```

**3).** Install required packages using pip:  
```
pip install -r /storage/zhangyanxiaoLab/xiongxiong/scripts/paired_tag/requirement.txt
```


**4).** Use scripts in `/pipelines/` to analysis your data.

## A recommended pipeline  
**1).** Go to or make your project directory, create and copy/link your fastq files in the fastq folder `project/fastq`. Rename your fastq files in *_R1.fastq.gz and *_R2.fastq.gz format if necessary. Perform basic analysis for each sub-library.

```
bash /pipelines/pipeline_PT.sh -g <reference_genome> -l <library>
```

**Note:** DNA and RNA library should be run separately.  

**2).** (Optional but highly recommend) Check if the quantity and quality of nuclei left are in line with expectations:

```
Rscript /analysis/line_barcodeProp.R <path_to_barcode_count 1> <path_to_barcode_count 2> ... <path_to_barcode_count n>
```

**Note:**  
1. <path_to_barcode_count> are prefix_CB.Counts files (in process folder), which are auto-generated by step 1) with barcode in first column, read count in second column.   
2. R package: *ggplot2* is required.

```
Rscript /analysis/dot_reads_numbers.R <DNA_cutoff> <RNA_cutoff> <path_to_barcode_count_pair 1> <path_to_barcode_count_pair 2> ... <path_to_barcode_count_pair n>
```

**Note:**  
1. <path_to_barcode_count_pair> are paired prefix_CB.Counts files (in process folder), with DNA in first, followed by paired RNA, separated by ',';  
2. R packages: *ggplot2, patchwork* is required.


**3).** (Optional but highly recommend) Filter nuclei by transcripts and DNA sequcences for each sub-libary, then merge sub-libraries into one file (For DNA library, high pileup positions are also removed):

```
bash /pipelines/filter_merge_bam.sh [options] -i <bam_file_list>
```


**Note:** <bam_file_list> is a list includes path to paired (one sub-library) bam files, with DNA in first, followed by paried RNA, separated by comma in one line.

**4).** Generate matrix files compatible with seurat package.

***!!!Attention!!!*** Before this step, libraries should be separated by antibodies or enzymes if nuclei using different antibodies or enzymes are combined in experiment. An awesome script is provided here: `/scripts/extract_sample_barcode_from_bam.py`

```
bash /pipelines/bam2mtx.sh -n <output_prefix> -g <reference-genome> -i <input_bam> -l <library>
```


**5).** Cell clustering.

**Note:** This is a relatively tricky step, we highly recommend that adjust the package and parameters accordingly although a simple R script using Seurat packages is provided.
```
Rscript /analysis/seurat.R <path_to_matrix>
```

**6).** Separate DNA bam files according to cell clustering result:

```
bash /pipelines/pseudo_bulk.sh [options] -i <input_bam> -t <cell_cluster>
```

**Note:** <cell_cluster> is a cell cluster list with barcode in first column, followed by cluster in second column, separated by tab.


**7).** (Optional) Down-sampling current library to estimate library complexity for further sequencing:

```
bash /pipeline/downsample.sh <path_to_DNA_bam> <path_to_RNA_bam 2>
```

**Note:** *picard* required.

**8).** (Optional) Enrichment analysis surrounding TSS and peak summit (from ChIP-seq) to estimate the quality of DNA library:

```
bash /pipeline/reads_overlap_with_peak.sh -b <input.bam> -n <name> -w <input.bw> -r <reference.bw>
```

**Note:** *deeptools* required.

## Full list of options


## Results

